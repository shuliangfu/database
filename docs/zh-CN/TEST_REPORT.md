# @dreamer/database 测试报告

## query() 与 find() 的区别

### 简要对比

| 特性             | `query()`                                                                  | `find()`                                                                                              |
| ---------------- | -------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **初始条件**     | 不需要                                                                     | 必须提供                                                                                              |
| **查询条件方法** | ✅ 支持全部（`where`、`orWhere`、`andWhere`、`like`、`orLike`、`andLike`） | ✅ 支持追加方法（`orWhere`、`andWhere`、`orLike`、`andLike`）<br>❌ 不支持重置方法（`where`、`like`） |
| **操作方法**     | ✅ 支持 update、delete 等                                                  | ❌ 仅查询                                                                                             |
| **findById()**   | ✅                                                                         | ❌（find 本身需传入 ID）                                                                              |
| **使用场景**     | 从空查询构建复杂查询与操作                                                 | 从已知条件快速查询                                                                                    |

### 共同点

- ✅ 均支持相同链式查询方法（`orWhere`、`andWhere`、`orLike`、`andLike` 等）
- ✅ 均支持相同查询方法（`findAll`、`findOne`、`count`、`exists`、`paginate`
  等）
- ✅ 均支持 `asArray()` 返回纯 JSON 对象数组
- ✅ 均支持排序、分页、字段选择等
- ✅ 均支持直接 await 返回单条记录

### 选择建议

- **使用 `query()`**：从空查询构建复杂查询、需要执行 update/delete、需要
  `findById()`、需要完整查询构建能力。
- **使用 `find()`**：已有初始条件（ID
  或条件对象）、快速查询单条或列表、仅做查询不需 update/delete。

---

## 测试概览

- **测试库版本**：@dreamer/test@^1.0.0-beta.40
- **运行时适配器**：@dreamer/runtime-adapter@^1.0.0
- **测试框架**：@dreamer/test（兼容 Deno 与 Bun）
- **测试日期**：2026-02-06
- **服务容器**：@dreamer/service@^1.0.0-beta.4
- **测试环境**：Deno 2.5.0+，Bun 1.3.0+

---

## 测试结果

### 总体统计

- **总用例数**：1,954
- **通过**：1,954 ✅
- **失败**：0
- **通过率**：100% ✅
- **执行时间**：约 129 秒（Deno，按数据库分别执行）
- **测试文件数**：81

### 按适配器统计

| 适配器                  | 用例数 | 说明         |
| ----------------------- | ------ | ------------ |
| integration（多适配器） | 4      | 多库联合测试 |
| MongoDB                 | 497    | 文档库       |
| MySQL                   | 481    | 关系型       |
| PostgreSQL              | 488    | 关系型       |
| SQLite                  | 484    | 嵌入式       |

---

## 功能测试要点

- **ORM 模型**：各适配器 172～175
  个用例，CRUD、链式查询、软删除、关联查询等全部通过
- **数据校验**：30+ 规则，跨字段/跨表/条件/异步校验均通过
- **适配器**：连接管理、查询执行、错误处理、健康检查等通过
- **查询构建器**：SELECT/WHERE/JOIN/ORDER/LIMIT 及参数化查询通过
- **事务**：提交、回滚、嵌套事务（savepoint）通过
- **缓存**：查询结果缓存与失效机制通过
- **错误处理**：连接/查询/事务/连接池错误等通过
- **QueryLogger**：日志级别、慢查询、错误日志、i18n 翻译（lang）通过
- **初始化与访问**：initDatabase、getDatabase、getDatabaseManager 等通过
- **集成**：多适配器同时操作（MySQL、SQLite、MongoDB）4 个用例通过

---

## 适配器能力概览

| 能力模块      | MySQL | PostgreSQL | SQLite | MongoDB |
| ------------- | ----- | ---------- | ------ | ------- |
| CRUD          | ✅    | ✅         | ✅     | ✅      |
| 查询构建器    | ✅    | ✅         | ✅     | ✅      |
| 数据校验      | ✅    | ✅         | ✅     | ✅      |
| 事务          | ✅    | ✅         | ✅     | ✅      |
| 软删除        | ✅    | ✅         | ✅     | ✅      |
| 关联查询      | ✅    | ✅         | ✅     | ✅      |
| 查询缓存      | ✅    | ✅         | ✅     | ✅      |
| asArray()     | ✅    | ✅         | ✅     | ✅      |
| 连接池        | ✅    | ✅         | ✅     | -       |
| 嵌套事务      | ✅    | ✅         | ✅     | -       |
| 聚合/嵌套文档 | -     | -          | -      | ✅      |

---

## 结论

@dreamer/database 共 1,954 个用例全部通过，通过率 100%。

**要点**：

- ✅ 四种适配器（MySQL、PostgreSQL、SQLite、MongoDB）全部通过
- ✅ 统一 ORM 接口，参数一致
- ✅ `query()` 支持完整查询条件 API；`find()` 支持追加条件，符合语义设计
- ✅ 30+ 校验规则、软删除、关联、事务等均通过
- ✅ 无资源泄漏，长时间运行稳定

**可安全用于生产环境。**

---

_测试报告生成日期：2026-02-06_ _测试工具：@dreamer/test（兼容 Deno 与 Bun）_
